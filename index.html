<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Beat Saber Web</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: #0a0a0a; color: white; }
        #container { position: relative; width: 100vw; height: 100vh; }
        #gameCanvas { position: absolute; top:0; left:0; width:100%; height:100%; z-index:1; }
        #ui { position:absolute; top:20px; left:20px; z-index:2; background:rgba(0,0,0,0.7); padding:20px; border-radius:10px; backdrop-filter: blur(5px); }
        #score { font-size:36px; font-weight:bold; margin-bottom:10px; color:#00ff88; text-shadow:0 0 10px #00ff88; }
        #combo { font-size:24px; color:#ffaa00; margin-bottom:20px; }
        #message { font-size:18px; color:#888; margin-top:10px; }
        #startButton { background:linear-gradient(45deg,#ff0080,#00ff88); color:white; border:none; padding:12px 24px; font-size:18px; border-radius:25px; cursor:pointer; font-weight:bold; margin-top:10px; transition: transform 0.2s; }
        #startButton:hover { transform: scale(1.05); }
        #instructions { position:absolute; bottom:20px; left:50%; transform: translateX(-50%); background:rgba(0,0,0,0.7); padding:15px; border-radius:10px; text-align:center; z-index:2; backdrop-filter: blur(5px); }
        .hand-indicator { display:inline-block; width:20px; height:20px; border-radius:50%; margin:0 5px; }
        #leftHandIndicator { background-color: #ff0080; box-shadow:0 0 10px #ff0080; }
        #rightHandIndicator { background-color: #00ff88; box-shadow:0 0 10px #00ff88; }
        .loading { position:absolute; top:50%; left:50%; transform: translate(-50%,-50%); font-size:24px; color:white; z-index:10; }
        /* Скрываем камеру */
        #videoContainer { display:none; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
<div id="container">
    <div id="ui">
        <div id="score">0</div>
        <div id="combo">Combo: 0</div>
        <div id="message">Загружаю детектор рук...</div>
        <button id="startButton">СТАРТ ИГРЫ</button>
    </div>
    
    <div id="videoContainer">
        <video id="inputVideo" autoplay playsinline></video>
    </div>
    
    <div id="instructions">
        <span>Управление: </span>
        <span class="hand-indicator" id="leftHandIndicator"></span> Левая рука
        <span style="margin:0 10px">|</span>
        <span class="hand-indicator" id="rightHandIndicator"></span> Правая рука
        <div style="margin-top:5px; font-size:14px; color:#aaa">Размахивайте руками, чтобы резать кубы!</div>
    </div>
    
    <canvas id="gameCanvas"></canvas>
</div>

<script>
let scene, camera, renderer, controls;
let hands, cameraInstance;
let gameStarted = false;
let score = 0, combo = 0, maxCombo = 0, missedCubes = 0;
let cubes = [];
let sabers = { left:null, right:null };
let trails = { left:null, right:null };
let lastCutTime = 0, cubeSpawnInterval = null, gameStartTime = 0;

const scoreElement = document.getElementById('score');
const comboElement = document.getElementById('combo');
const messageElement = document.getElementById('message');
const startButton = document.getElementById('startButton');
const leftHandIndicator = document.getElementById('leftHandIndicator');
const rightHandIndicator = document.getElementById('rightHandIndicator');
const videoElement = document.getElementById('inputVideo');

const COLORS = {
    RED:0xff0080, BLUE:0x0080ff, GREEN:0x00ff88, PURPLE:0x8000ff,
    SABER_LEFT:0xff0080, SABER_RIGHT:0x00ff88,
    TRAIL_LEFT:0xff0080, TRAIL_RIGHT:0x00ff88,
    BACKGROUND:0x0a0a0a
};

const handsConfig = { locateFile: (file)=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` };

// Three.js
function initThreeJS() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(COLORS.BACKGROUND);
    scene.fog = new THREE.Fog(COLORS.BACKGROUND,10,25);
    camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight,0.1,1000);
    camera.position.set(0,1.5,5); camera.lookAt(0,1,0);
    renderer = new THREE.WebGLRenderer({canvas:document.getElementById('gameCanvas'), antialias:true, alpha:true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true; renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    
    const ambientLight = new THREE.AmbientLight(0x404040,0.6); scene.add(ambientLight);
    const directionalLight = new THREE.DirectionalLight(0xffffff,0.8);
    directionalLight.position.set(5,10,7); directionalLight.castShadow = true;
    scene.add(directionalLight);
    
    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.dampingFactor=0.05; controls.enabled=false;
    
    createSaber('left', COLORS.SABER_LEFT); createSaber('right', COLORS.SABER_RIGHT);
    createTrail('left', COLORS.TRAIL_LEFT); createTrail('right', COLORS.TRAIL_RIGHT);
    createGameZone();
    
    window.addEventListener('resize', onWindowResize);
    messageElement.textContent = "Детектор рук готов! Нажмите СТАРТ ИГРЫ";
}

// Сабли
function createSaber(side,color) {
    const group = new THREE.Group();
    const handle = new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,0.3,8), new THREE.MeshPhongMaterial({color:0x333333,shininess:100}));
    handle.position.y=0.15; group.add(handle);
    const blade = new THREE.Mesh(new THREE.BoxGeometry(0.02,0.8,0.02), new THREE.MeshPhongMaterial({color,color,emissive:color,emissiveIntensity:0.5,shininess:100,transparent:true,opacity:0.9}));
    blade.position.y=0.7; group.add(blade);
    const glow = new THREE.Mesh(new THREE.CylinderGeometry(0.03,0.03,0.85,16), new THREE.MeshBasicMaterial({color,transparent:true,opacity:0.2,side:THREE.BackSide}));
    glow.position.y=0.675; group.add(glow);
    scene.add(group);
    sabers[side] = {group, blade, glow, position:new THREE.Vector3(), velocity:new THREE.Vector3(), lastPosition:new THREE.Vector3(), isDetected:false};
    group.visible=false;
}

// Следы
function createTrail(side,color) {
    const trailGeometry = new THREE.BufferGeometry();
    const trailMaterial = new THREE.LineBasicMaterial({color,transparent:true,opacity:0.6,linewidth:2});
    const trail = new THREE.Line(trailGeometry, trailMaterial); scene.add(trail);
    trails[side] = {line:trail, points:[], maxPoints:20};
    trail.visible=false;
}
function updateTrail(side, position) {
    const trail = trails[side]; if(!trail||!sabers[side].isDetected)return;
    trail.points.unshift(position.clone());
    if(trail.points.length>trail.maxPoints) trail.points.pop();
    const positions = new Float32Array(trail.points.length*3);
    for(let i=0;i<trail.points.length;i++){positions[i*3]=trail.points[i].x;positions[i*3+1]=trail.points[i].y;positions[i*3+2]=trail.points[i].z;}
    trail.line.geometry.setAttribute('position', new THREE.BufferAttribute(positions,3));
    trail.line.geometry.attributes.position.needsUpdate=true; trail.line.visible=true;
}

// Зона
function createGameZone() {
    const floor = new THREE.Mesh(new THREE.PlaneGeometry(20,20), new THREE.MeshPhongMaterial({color:0x222222,shininess:30,side:THREE.DoubleSide}));
    floor.rotation.x=Math.PI/2; floor.position.y=-0.5; floor.receiveShadow=true; scene.add(floor);
    const backWall = new THREE.Mesh(new THREE.PlaneGeometry(20,5), new THREE.MeshPhongMaterial({color:0x1a1a1a,side:THREE.DoubleSide}));
    backWall.position.z=-10; backWall.position.y=2; scene.add(backWall);
}

// Кубы
function createCube() {
    const colors=[COLORS.RED,COLORS.BLUE,COLORS.GREEN,COLORS.PURPLE];
    const color = colors[Math.floor(Math.random()*colors.length)];
    const geometry = new THREE.BoxGeometry(0.7,0.7,0.7);
    const material = new THREE.MeshPhongMaterial({color,emissive:color,emissiveIntensity:0.2,shininess:100});
    const cube = new THREE.Mesh(geometry, material); cube.castShadow=true; cube.receiveShadow=true;
    const lanePositions=[-1.5,-0.5,0.5,1.5];
    const lane = lanePositions[Math.floor(Math.random()*lanePositions.length)];
    cube.position.set(lane,1,10);
    cube.userData={targetHand:lane<0?'left':'right',color,speed:0.1+Math.random()*0.05,direction:new THREE.Vector3(0,0,-1),spawnTime:Date.now(),isActive:true};
    scene.add(cube); cubes.push(cube); return cube;
}

// Детектор рук
async function initHandDetection() {
    hands=new Hands(handsConfig);
    hands.setOptions({maxNumHands:2,modelComplexity:1,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
    hands.onResults(onHandResults);
    cameraInstance = new Camera(videoElement,{onFrame: async()=>{await hands.send({image:videoElement});}, width:640, height:480});
    try { await cameraInstance.start(); messageElement.textContent="Камера запущена! Нажмите СТАРТ ИГРЫ"; } 
    catch(error){ messageElement.textContent="Ошибка доступа к камере: "+error.message; console.error(error);}
}

// Результаты
function onHandResults(results) {
    if(!gameStarted) return;
    sabers.left.isDetected=false; sabers.right.isDetected=false;
    leftHandIndicator.style.backgroundColor='#555'; rightHandIndicator.style.backgroundColor='#555';
    if(results.multiHandLandmarks&&results.multiHandedness){
        for(let i=0;i<Math.min(results.multiHandLandmarks.length,2);i++){
            const landmarks = results.multiHandLandmarks[i]; const handedness = results.multiHandedness[i].label.toLowerCase();
            const wrist=landmarks[0]; const x=(wrist.x-0.5)*4; const y=(0.5-wrist.y)*3; const z=wrist.z*2;
            if(sabers[handedness]){
                const saber = sabers[handedness];
                const newPosition = new THREE.Vector3(x,y+0.5,z-2);
                saber.velocity.subVectors(newPosition,saber.position).multiplyScalar(0.3);
                saber.lastPosition.copy(saber.position); saber.position.copy(newPosition);
                saber.group.position.copy(saber.position);
                if(saber.velocity.length()>0.01) saber.group.lookAt(saber.position.clone().add(saber.velocity));
                updateTrail(handedness,saber.position.clone().add(new THREE.Vector3(0,0.5,0)));
                saber.isDetected=true; saber.group.visible=true;
                if(handedness==='left'){ leftHandIndicator.style.backgroundColor='#ff0080'; leftHandIndicator.style.boxShadow='0 0 10px #ff0080'; }
                else { rightHandIndicator.style.backgroundColor='#00ff88'; rightHandIndicator.style.boxShadow='0 0 10px #00ff88'; }
                checkCollisions(handedness);
            }
        }
    }
    if(!sabers.left.isDetected){ sabers.left.group.visible=false; trails.left.line.visible=false;}
    if(!sabers.right.isDetected){ sabers.right.group.visible=false; trails.right.line.visible=false;}
}

// Проверка коллизий
function checkCollisions(handKey){
    const saber = sabers[handKey]; if(!saber||!saber.isDetected)return;
    const saberSphere = new THREE.Sphere(saber.position,0.5);
    for(let i=cubes.length-1;i>=0;i--){
        const cube=cubes[i]; if(!cube.userData.isActive)continue;
        if(cube.userData.targetHand!==handKey)continue;
        const cubeSphere = new THREE.Sphere(cube.position,0.5);
        if(saberSphere.intersectsSphere(cubeSphere)){
            if(saber.velocity.length()>0.1){ cutCube(cube,handKey); cubes.splice(i,1); }
        }
    }
}

// Разрезание
function cutCube(cube,handKey){
    cube.userData.isActive=false; combo++; score+=10*combo; if(combo>maxCombo) maxCombo=combo;
    scoreElement.textContent=score; comboElement.textContent=`Combo: ${combo} (Max: ${maxCombo})`;
    comboElement.style.color=combo>=10?'#ffaa00':'#00ff88';
    createParticleExplosion(cube.position,cube.userData.color);
    if(navigator.vibrate) navigator.vibrate(50);
    scene.remove(cube); lastCutTime=Date.now();
}

function createParticleExplosion(position,color){
    const particleCount=20; const geometry=new THREE.BufferGeometry(); const vertices=[];
    for(let i=0;i<particleCount;i++){ vertices.push((Math.random()-0.5)*0.5,(Math.random()-0.5)*0.5,(Math.random()-0.5)*0.5);}
    geometry.setAttribute('position',new THREE.Float32BufferAttribute(vertices,3));
    const material=new THREE.PointsMaterial({color,size:0.05,transparent:true,opacity:0.8});
    const particles = new THREE.Points(geometry,material); particles.position.copy(position); scene.add(particles);
    const particleData=[]; for(let i=0;i<particleCount;i++){ particleData.push({velocity:new THREE.Vector3((Math.random()-0.5)*0.2,(Math.random()-0.5)*0.2,(Math.random()-0.5)*0.2),life:1.0});}
    function animateParticles(){
        let allDead=true; const positions=particles.geometry.attributes.position.array;
        for(let i=0;i<particleCount;i++){
            const data=particleData[i];
            if(data.life>0){ allDead=false; data.life-=0.05; positions[i*3]+=data.velocity.x; positions[i*3+1]+=data.velocity.y; positions[i*3+2]+=data.velocity.z; data.velocity.y-=0.01;}
        }
        particles.geometry.attributes.position.needsUpdate=true; material.opacity-=0.02;
        if(allDead||material.opacity<=0){ scene.remove(particles); return;}
        requestAnimationFrame(animateParticles);
    }
    animateParticles();
}

// Игра
function startGame(){
    if(gameStarted) return; gameStarted=true; gameStartTime=Date.now(); score=0; combo=0; missedCubes=0;
    cubes.forEach(cube=>scene.remove(cube)); cubes=[];
    scoreElement.textContent="0"; comboElement.textContent="Combo: 0 (Max: 0)"; comboElement.style.color='#00ff88';
    messageElement.textContent="Игра началась! Режьте кубы!"; startButton.textContent="ПЕРЕЗАПУСТИТЬ ИГРУ";
    if(cubeSpawnInterval) clearInterval(cubeSpawnInterval);
    cubeSpawnInterval=setInterval(()=>{
        if(gameStarted){ createCube();
            if(Date.now()-gameStartTime>30000) createCube();
            if(Date.now()-gameStartTime>60000) createCube();
        }
    },1000);
    leftHandIndicator.style.backgroundColor='#555'; rightHandIndicator.style.backgroundColor='#555';
}

function stopGame(){
    gameStarted=false; if(cubeSpawnInterval) clearInterval(cubeSpawnInterval);
    messageElement.textContent=`Игра окончена! Счет: ${score}, Макс. комбо: ${maxCombo}`;
    startButton.textContent="НАЧАТЬ ЗАНОВО";
}

function updateGame(){
    if(!gameStarted) return; const currentTime=Date
