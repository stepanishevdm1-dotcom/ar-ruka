<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Web 3D Beat Saber</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
<style>
body { margin:0; overflow:hidden; background:black; }
#score { position:fixed; top:20px; left:20px; color:white; font-size:24px; font-family:sans-serif; z-index:10; }
</style>
</head>
<body>
<div id="score">Score: 0</div>
<video id="video" autoplay playsinline style="display:none"></video>
<script>
// ===== Three.js сцена =====
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

camera.position.z = 5;

// Свет
const light = new THREE.DirectionalLight(0xffffff,1);
light.position.set(0,5,5);
scene.add(light);

// ===== Кубы =====
const cubes = [];
const cubeSize = 0.5;
let lastSpawn = Date.now();
const spawnInterval = 1000; // мс

function spawnCube(){
    const geometry = new THREE.BoxGeometry(cubeSize,cubeSize,cubeSize);
    const material = new THREE.MeshStandardMaterial({color:0x4CC9F0});
    const cube = new THREE.Mesh(geometry, material);
    cube.position.x = (Math.random()-0.5)*4;
    cube.position.y = (Math.random()-0.5)*3;
    cube.position.z = 20; // старт далеко
    scene.add(cube);
    cubes.push(cube);
}

// ===== MediaPipe Hands =====
const video = document.getElementById("video");
let handsPos = []; // {x,y,z} в нормализованных координатах

const hands = new Hands({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({
    maxNumHands: 2,
    modelComplexity: 1,
    minDetectionConfidence: 0.7,
    minTrackingConfidence: 0.7
});

hands.onResults(results=>{
    handsPos = [];
    results.multiHandLandmarks.forEach(lm=>{
        const palm = lm[0];
        handsPos.push({
            x: (palm.x-0.5)*4, // конвертируем в Three.js координаты
            y: (0.5-palm.y)*3,
            z: 0
        });
    });
});

const cameraMP = new Camera(video, {
    onFrame: async()=>{ await hands.send({image:video}); },
    width:640,
    height:480,
    facingMode:"environment"
});
cameraMP.start();

// ===== Счет =====
let score = 0;
function updateScore(){ document.getElementById('score').textContent = 'Score: '+score; }

// ===== Анимация =====
function animate(){
    requestAnimationFrame(animate);

    // Спавн кубов
    if(Date.now()-lastSpawn>spawnInterval){
        spawnCube();
        lastSpawn = Date.now();
    }

    // Двигаем кубы к камере
    for(let i=cubes.length-1;i>=0;i--){
        const cube = cubes[i];
        cube.position.z -= 0.15;

        // Удаляем за камерой
        if(cube.position.z < -1){
            scene.remove(cube);
            cubes.splice(i,1);
            continue;
        }

        // Проверка попадания руки
        handsPos.forEach(hand=>{
            const dx = cube.position.x - hand.x;
            const dy = cube.position.y - hand.y;
            const dz = cube.position.z - hand.z;
            const distance = Math.sqrt(dx*dx + dy*dy + dz*dz);
            if(distance < cubeSize/1.5){
                scene.remove(cube);
                cubes.splice(i,1);
                score++;
                updateScore();
            }
        });
    }

    renderer.render(scene,camera);
}
animate();

// ===== Адаптация под окно =====
window.addEventListener('resize', ()=>{
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth,window.innerHeight);
});
</script>
</body>
</html>
