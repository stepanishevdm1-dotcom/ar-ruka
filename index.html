<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Hand AR Video (Fixed)</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
html,body{
  margin:0;
  padding:0;
  overflow:hidden;
  background:black;
}

/* –ö–∞–º–µ—Ä–∞ */
#camera {
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  object-fit:cover;
  z-index:0;
}

/* AR-–≤–∏–¥–µ–æ */
#videoBox{
  position:absolute;
  width:320px;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  z-index:2;
}
#videoBox video{
  width:100%;
  border-radius:12px;
}

/* Canvas —Ä—É–∫–∏ */
#handCanvas{
  position:fixed;
  inset:0;
  z-index:3;
  pointer-events:none;
}

/* UI */
#panel{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  z-index:4;
  background:rgba(0,0,0,.6);
  color:white;
  padding:10px 14px;
  border-radius:20px;
  font-size:14px;
}
#fileInput{display:none;}
</style>
</head>

<body>

<video id="camera" autoplay muted playsinline></video>

<div id="videoBox">
  <video id="video" loop playsinline></video>
</div>

<canvas id="handCanvas"></canvas>

<div id="panel">
  <button onclick="fileInput.click()">üìÅ –í–∏–¥–µ–æ</button>
  ‚úä –¥–≤–∏–≥–∞—Ç—å | ‚úã –æ—Å—Ç–∞–≤–∏—Ç—å
</div>
<input type="file" id="fileInput" accept="video/*">

<script>
const cam = document.getElementById("camera");
const box = document.getElementById("videoBox");
const video = document.getElementById("video");
const canvas = document.getElementById("handCanvas");
const ctx = canvas.getContext("2d");
const fileInput = document.getElementById("fileInput");

canvas.width = innerWidth;
canvas.height = innerHeight;

// –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ
fileInput.onchange = e=>{
  const f = e.target.files[0];
  if(!f) return;
  video.src = URL.createObjectURL(f);
  video.play();
};

let grabbed=false;
let grabDX=0, grabDY=0;

// MediaPipe
const hands = new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands:1,
  minDetectionConfidence:.7,
  minTrackingConfidence:.7
});

hands.onResults(r=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!r.multiHandLandmarks.length) return;

  const lm=r.multiHandLandmarks[0];
  drawConnectors(ctx,lm,HAND_CONNECTIONS,{color:"#00ff00"});
  drawLandmarks(ctx,lm,{color:"#ff0000"});

  const palm=lm[0];
  const thumb=lm[4];
  const index=lm[8];

  const pinch=Math.hypot(
    thumb.x-index.x,
    thumb.y-index.y
  )<0.045;

  const x=palm.x*innerWidth;
  const y=palm.y*innerHeight;

  if(pinch && !grabbed){
    grabbed=true;
    grabDX=x-box.offsetLeft;
    grabDY=y-box.offsetTop;
    video.play();
  }

  if(!pinch && grabbed){
    grabbed=false;
    video.pause();
  }

  if(grabbed){
    box.style.left=(x-grabDX)+"px";
    box.style.top =(y-grabDY)+"px";
  }
});

// –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
const camera = new Camera(cam,{
  facingMode:"environment",
  width:1280,
  height:720,
  onFrame:async()=>{
    await hands.send({image:cam});
  }
});
camera.start();
</script>

</body>
</html>
