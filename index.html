<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Web Beat Saber</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

<style>
body { margin:0; overflow:hidden; background:black; }
canvas { position:fixed; top:0; left:0; width:100vw; height:100vh; display:block; }
#score { position:fixed; top:20px; left:20px; color:white; font-size:24px; font-family:sans-serif; }
</style>
</head>
<body>

<video id="video" autoplay playsinline style="display:none"></video>
<canvas id="canvas"></canvas>
<div id="score">Score: 0</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

let handPos = {x: null, y: null};
let score = 0;

// ==== MediaPipe Hands ====
const hands = new Hands({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

hands.onResults(results => {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Рисуем ладонь
  if(results.multiHandLandmarks.length > 0){
    const lm = results.multiHandLandmarks[0];
    drawConnectors(ctx, lm, HAND_CONNECTIONS, {color:"#00FF00", lineWidth:4});
    drawLandmarks(ctx, lm, {color:"#FF0000", lineWidth:2});

    // Используем ладонь (landmark 0) для коллизий
    handPos.x = lm[0].x * canvas.width;
    handPos.y = lm[0].y * canvas.height;
  } else {
    handPos.x = null;
    handPos.y = null;
  }
});

// ==== Камера ====
const camera = new Camera(video, {
  onFrame: async () => { await hands.send({image: video}); },
  width: 1280,
  height: 720,
  facingMode: "environment"
});
camera.start();

// ==== Кубы ====
const cubes = [];
const cubeSize = 60;
const spawnInterval = 1000; // мс
let lastSpawn = Date.now();

function spawnCube(){
  const x = Math.random() * (canvas.width - cubeSize);
  const y = -cubeSize;
  cubes.push({x, y});
}

// ==== Анимация ====
function update(){
  // Спавн кубов
  if(Date.now() - lastSpawn > spawnInterval){
    spawnCube();
    lastSpawn = Date.now();
  }

  // Обновление кубов
  for(let i = cubes.length-1; i>=0; i--){
    const cube = cubes[i];
    cube.y += 5; // скорость падения

    // Проверка коллизии с рукой
    if(handPos.x !== null && handPos.y !== null){
      if(handPos.x > cube.x && handPos.x < cube.x + cubeSize &&
         handPos.y > cube.y && handPos.y < cube.y + cubeSize){
        cubes.splice(i,1);
        score++;
        document.getElementById('score').textContent = 'Score: ' + score;
        continue;
      }
    }

    // Удаляем кубы за экраном
    if(cube.y > canvas.height) cubes.splice(i,1);
  }
}

// ==== Рендеринг ====
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Кубы
  cubes.forEach(cube => {
    ctx.fillStyle = '#4CC9F0';
    ctx.fillRect(cube.x, cube.y, cubeSize, cubeSize);
  });

  requestAnimationFrame(draw);
}

// ==== Цикл игры ====
function gameLoop(){
  update();
  requestAnimationFrame(gameLoop);
}

draw();
gameLoop();

</script>
</body>
</html>
